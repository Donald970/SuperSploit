# python3 test.py RHOST='' RPORT='' EXE='' UID=''
import subprocess

integrated = False
from .database import jsdm
import os
install_location = f"/home/{os.getlogin()}/SuperSploit"
tmp_exploit_package_path = f"{install_location}/core/start/integrated_exploits/"

class exploit:

    def __init__(self):
        return

    @classmethod
    def py_setup(cls, da, file, vars, db, integrated):
        print(f"Crating module from exploit")
        with open(db["EXPLOIT"], "r") as file:
            fileR = file.read()
            file.close()

        with open(f"{tmp_exploit_package_path}/tmp.py", "w") as fileW:
            fileW.write(fileR)
            fileW.close()

        with open(f"{tmp_exploit_package_path}/__init__.py", "w") as file:
            file.write("from .tmp import exploit")
            file.close()
        print("module Created successfully")
        cls.run_python_exploit(vars, db)

    @classmethod
    def exploit(cls, da):
        db = jsdm.checkDb()
        file = db["EXPLOIT"]
        vars = []
        typs = ["py"]
        fun = [cls.py_setup]
        with open(file, "r") as rfile:
            data = rfile.read().split("# DETAILS #")
            rfile.close()
            fileList = str(data[1]).split("\n")
            for z in fileList:
                if fileList.index(z) > 0:
                    if fileList.index(z) == len(fileList) - 1:
                        break
                    vars.append(z.split(" ")[1])
        type = file.split("/")[len(file.split('/')) -1].split(".")[1]
        print(f"exploit type: {type}")
        if len(vars) > 0:
            integrated = True
        if type in typs:
            fun[typs.index(type)](da, file, vars, db, integrated)

    @classmethod
    def run_python_exploit(cls, args, db):
        l = []
        for x in args:
            for k, v in db.items():
                if x == k:
                    print(v)
                    l.append(v)
        try:
            print("Trying to import")
            from .integrated_exploits import exploit
            print("imported successfully\nTrying to run..")
            exploit(l)
            print("Exploit completed successfully\nCleaning up")
            subprocess.run(["rm", f"{tmp_exploit_package_path}/tmp.py"])
            with open(f"{tmp_exploit_package_path}/__init__.py", "w") as file:
                file.write("")
                file.close()
            return True
        except Exception as e:
            print(e)
